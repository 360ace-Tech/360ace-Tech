name: CI - Build & Test

on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - dev
      - 'feature/**'
      - 'fix/**'
    # Note: main branch excluded by not listing it above (production handled separately)

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Contentlayer
        run: npx contentlayer2 build

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript type check
        run: npm run typecheck

  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create minimal .env.local for build
        run: |
          cat > .env.local << EOF
          # Minimal environment for CI build validation
          NEXT_PUBLIC_SITE_URL=https://360ace.tech
          NEXT_PUBLIC_GA_ID=
          NEXT_PUBLIC_MAINTENANCE=false
          NEXT_PUBLIC_REOPEN_AT=

          # Contact form (not needed for build, but prevents warnings)
          SENDGRID_API_KEY=ci_build_placeholder
          CONTACT_TO_EMAIL=ci@example.com
          CONTACT_FROM_EMAIL=no-reply@example.com
          CONTACT_SUBJECT_PREFIX="Contact:"

          # reCAPTCHA (not needed for build)
          NEXT_PUBLIC_RECAPTCHA_SITE_KEY=ci_placeholder
          RECAPTCHA_SECRET=ci_placeholder
          NEXT_PUBLIC_RECAPTCHA_MODE=visible

          # Anti-spam timing
          CONTACT_MIN_SUBMIT_MS=2000
          EOF

      - name: Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Check build artifacts
        run: |
          echo "Checking build output..."
          if [ ! -d ".next" ]; then
            echo "Error: .next directory not found!"
            exit 1
          fi

          if [ ! -f ".next/BUILD_ID" ]; then
            echo "Error: BUILD_ID not found!"
            exit 1
          fi

          echo "Build ID: $(cat .next/BUILD_ID)"
          echo "Build successful!"

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, build]
    if: always()

    steps:
      - name: Check job statuses
        run: |
          echo "Lint & Type Check: ${{ needs.lint-and-typecheck.result }}"
          echo "Build: ${{ needs.build.result }}"

          if [ "${{ needs.lint-and-typecheck.result }}" != "success" ] || [ "${{ needs.build.result }}" != "success" ]; then
            echo "CI checks failed!"
            exit 1
          fi

          echo "All CI checks passed!"
